# How to Get FCM Token for Testing

## ⚠️ Important: Firebase Console Cannot Generate Tokens

**Firebase Console can only SEND messages to tokens that already exist.** It cannot generate tokens for you.

**Tokens MUST come from your mobile app (Android/iOS) that is configured with your Firebase project.**

---

## Complete Process Flow

```
1. Configure Mobile App with Firebase
   ↓
2. App Gets FCM Token (automatically generated by Firebase SDK)
   ↓
3. App Sends Token to Your API (POST /api/fcm/register-token)
   ↓
4. Token Saved in Database
   ↓
5. Send Notification via API (POST /api/fcm/send-message)
   ↓
6. Notification Received on Device
```

---

## Step-by-Step: Get FCM Token from Android App

### Prerequisites:
1. ✅ Android app project
2. ✅ Firebase project created (Sender ID: `494935832712`)
3. ✅ `google-services.json` file downloaded from Firebase Console
4. ✅ Firebase SDK added to your Android app

### Step 1: Add Firebase to Android App

1. **Download `google-services.json`**:
   - Go to Firebase Console → Your Project
   - Project Settings → General tab
   - Scroll to "Your apps" section
   - Click Android icon → Register app
   - Download `google-services.json`
   - Place it in: `app/google-services.json`

2. **Add Firebase SDK to `build.gradle` (Project level)**:
   ```gradle
   buildscript {
       dependencies {
           classpath 'com.google.gms:google-services:4.4.0'
       }
   }
   ```

3. **Add Firebase SDK to `build.gradle` (App level)**:
   ```gradle
   apply plugin: 'com.google.gms.google-services'
   
   dependencies {
       implementation 'com.google.firebase:firebase-messaging:23.4.0'
       implementation 'com.google.firebase:firebase-analytics:21.5.0'
   }
   ```

### Step 2: Get FCM Token in Your Android App

**Add this code to your Android app** (e.g., in `MainActivity.java` or `MainActivity.kt`):

#### For Java:
```java
import com.google.firebase.messaging.FirebaseMessaging;
import android.util.Log;

public class MainActivity extends AppCompatActivity {
    private static final String TAG = "FCMToken";
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        // Get FCM token
        FirebaseMessaging.getInstance().getToken()
            .addOnCompleteListener(new OnCompleteListener<String>() {
                @Override
                public void onComplete(@NonNull Task<String> task) {
                    if (!task.isSuccessful()) {
                        Log.w(TAG, "Fetching FCM registration token failed", task.getException());
                        return;
                    }

                    // Get new FCM registration token
                    String token = task.getResult();
                    
                    // Log the token (you'll see this in Logcat)
                    Log.d(TAG, "FCM Registration Token: " + token);
                    
                    // Display token in UI or send to your API
                    // Example: sendTokenToServer(token);
                }
            });
    }
    
    // Method to send token to your API
    private void sendTokenToServer(String token) {
        // Make HTTP POST request to: https://your-domain.com/api/fcm/register-token
        // Body: {"token": token, "client_id": user_id}
    }
}
```

#### For Kotlin:
```kotlin
import com.google.firebase.messaging.FirebaseMessaging
import android.util.Log

class MainActivity : AppCompatActivity() {
    private val TAG = "FCMToken"
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        // Get FCM token
        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
            if (!task.isSuccessful) {
                Log.w(TAG, "Fetching FCM registration token failed", task.exception)
                return@addOnCompleteListener
            }

            // Get new FCM registration token
            val token = task.result
            
            // Log the token (you'll see this in Logcat)
            Log.d(TAG, "FCM Registration Token: $token")
            
            // Display token in UI or send to your API
            // Example: sendTokenToServer(token)
        }
    }
    
    // Method to send token to your API
    private fun sendTokenToServer(token: String) {
        // Make HTTP POST request to: https://your-domain.com/api/fcm/register-token
        // Body: {"token": token, "client_id": user_id}
    }
}
```

### Step 3: View Token in Logcat

1. **Run your app** on Android device/emulator
2. **Open Logcat** in Android Studio
3. **Filter by tag**: `FCMToken`
4. **Copy the token** from the log output

**Example log output:**
```
D/FCMToken: FCM Registration Token: ePsLfxe8RIiQjP1DfIZrTe:APA91bEeN0y3mN5LRGT1orLDdRMRT4XPVjto4uGyoI-mEu0C6A_10Dtf__Z4DbwseNUC7bS6YdtDfzyYqjGUF-zTzPbLh7qcqZUXQgY5p9oZcvfpBinKjgk
```

### Step 4: Register Token via API

**Use Postman or cURL:**

```bash
POST https://your-domain.com/api/fcm/register-token
Headers:
  Authorization: Bearer YOUR_AUTH_TOKEN
  Content-Type: application/json

Body:
{
  "token": "ePsLfxe8RIiQjP1DfIZrTe:APA91bEeN0y3mN5LRGT1orLDdRMRT4XPVjto4uGyoI-mEu0C6A_10Dtf__Z4DbwseNUC7bS6YdtDfzyYqjGUF-zTzPbLh7qcqZUXQgY5p9oZcvfpBinKjgk",
  "client_id": 36464
}
```

---

## Step-by-Step: Get FCM Token from iOS App

### Prerequisites:
1. ✅ iOS app project
2. ✅ Firebase project created (Sender ID: `494935832712`)
3. ✅ `GoogleService-Info.plist` downloaded from Firebase Console
4. ✅ Firebase SDK added via CocoaPods or Swift Package Manager

### Step 1: Add Firebase to iOS App

1. **Download `GoogleService-Info.plist`**:
   - Go to Firebase Console → Your Project
   - Project Settings → General tab
   - Scroll to "Your apps" section
   - Click iOS icon → Register app
   - Download `GoogleService-Info.plist`
   - Add it to your Xcode project

2. **Add Firebase SDK** (via CocoaPods):
   ```ruby
   # Podfile
   pod 'Firebase/Messaging'
   pod 'Firebase/Analytics'
   ```

### Step 2: Get FCM Token in Your iOS App

**Add this code to your iOS app** (e.g., in `AppDelegate.swift`):

```swift
import UIKit
import Firebase
import FirebaseMessaging

@main
class AppDelegate: UIResponder, UIApplicationDelegate, MessagingDelegate {
    
    func application(_ application: UIApplication, 
                   didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        
        FirebaseApp.configure()
        Messaging.messaging().delegate = self
        
        // Request notification permissions
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in
            if granted {
                DispatchQueue.main.async {
                    application.registerForRemoteNotifications()
                }
            }
        }
        
        return true
    }
    
    func application(_ application: UIApplication, 
                   didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        Messaging.messaging().apnsToken = deviceToken
    }
    
    // FCM Token Delegate Method
    func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {
        print("FCM Registration Token: \(fcmToken ?? "nil")")
        
        // Send token to your API
        if let token = fcmToken {
            sendTokenToServer(token: token)
        }
    }
    
    // Method to send token to your API
    func sendTokenToServer(token: String) {
        // Make HTTP POST request to: https://your-domain.com/api/fcm/register-token
        // Body: {"token": token, "client_id": user_id}
    }
}
```

### Step 3: View Token in Console

1. **Run your app** on iOS device/simulator
2. **Check Xcode console** for the token
3. **Copy the token** from console output

---

## Step-by-Step: Get FCM Token from Web App

### For Web (JavaScript):

```javascript
import { initializeApp } from 'firebase/app';
import { getMessaging, getToken } from 'firebase/messaging';

// Initialize Firebase
const firebaseConfig = {
  // Your Firebase config from Firebase Console
};

const app = initializeApp(firebaseConfig);
const messaging = getMessaging(app);

// Get FCM token
getToken(messaging, { vapidKey: 'YOUR_VAPID_KEY' })
  .then((currentToken) => {
    if (currentToken) {
      console.log('FCM Registration Token:', currentToken);
      // Send token to your API
      sendTokenToServer(currentToken);
    } else {
      console.log('No registration token available. Request permission to generate one.');
    }
  })
  .catch((err) => {
    console.log('An error occurred while retrieving token. ', err);
  });

function sendTokenToServer(token) {
  // Make HTTP POST request to: https://your-domain.com/api/fcm/register-token
  // Body: {"token": token, "client_id": user_id}
}
```

---

## Why Notifications Might Not Be Received

### Common Issues:

1. **SenderId Mismatch** (You had this error):
   - **Problem**: Token was generated from a different Firebase project
   - **Solution**: Ensure your mobile app uses the same Firebase project (Sender ID: `494935832712`)
   - **Check**: Verify `google-services.json` (Android) or `GoogleService-Info.plist` (iOS) matches your Firebase project

2. **Invalid Token**:
   - **Problem**: Token is expired or invalid
   - **Solution**: Get a fresh token from the app and re-register

3. **App Not Configured**:
   - **Problem**: Firebase SDK not properly initialized
   - **Solution**: Verify Firebase configuration in your app

4. **Notification Permissions**:
   - **Problem**: User denied notification permissions
   - **Solution**: Request permissions again in app settings

5. **App in Background**:
   - **Problem**: App might not handle background notifications
   - **Solution**: Implement notification handlers in your app

---

## Quick Test Checklist

- [ ] Mobile app has Firebase SDK installed
- [ ] `google-services.json` (Android) or `GoogleService-Info.plist` (iOS) is from the correct Firebase project
- [ ] App requests notification permissions
- [ ] FCM token is logged/displayed in app
- [ ] Token is registered via API (`POST /api/fcm/register-token`)
- [ ] Token appears in database (`device_tokens` table)
- [ ] Test notification sent via API (`POST /api/fcm/send-message`)
- [ ] Notification received on device

---

## Alternative: Use Firebase Console to Send Test Message

**After you have a token from your app:**

1. Go to Firebase Console → Your Project
2. Navigate to **Cloud Messaging** → **Send your first message**
3. Click **Send test message**
4. Paste your FCM token (from your app)
5. Enter title and message
6. Click **Test**

**This will send a notification directly to your device to verify the token works.**

---

## Need Help?

If you're still having issues:
1. Check Laravel logs: `storage/logs/laravel.log`
2. Check Firebase Console → Cloud Messaging → Delivery reports
3. Verify your service account JSON file is correct
4. Ensure your mobile app's Firebase project matches your backend's Firebase project

