<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real-time Messaging</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .message {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .message.urgent {
            border-left-color: #dc3545;
            background: #fff3cd;
        }
        .message.important {
            border-left-color: #ffc107;
            background: #d1ecf1;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .status.error {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Real-time Messaging Test</h1>
    
    <!-- Connection Status -->
    <div id="connection-status" class="status disconnected">
        ðŸ”´ Disconnected
    </div>
    
    <!-- Configuration -->
    <div class="container">
        <h3>Configuration</h3>
        <div>
            <label>API Base URL:</label>
            <input type="text" id="api-base-url" value="http://localhost/migration_manager_crm/public/api" placeholder="Enter your API base URL">
        </div>
        <div>
            <label>Auth Token:</label>
            <input type="text" id="auth-token" placeholder="Enter your authentication token">
        </div>
        <div>
            <label>User ID:</label>
            <input type="number" id="user-id" placeholder="Enter your user ID">
        </div>
        <button onclick="initializeConnection()">Initialize Connection</button>
    </div>
    
    <!-- Send Message Form -->
    <div class="container">
        <h3>Send Message</h3>
        <div>
            <label>Recipient ID:</label>
            <input type="number" id="recipient-id" placeholder="Enter recipient ID">
        </div>
        <div>
            <label>Subject:</label>
            <input type="text" id="message-subject" placeholder="Enter message subject">
        </div>
        <div>
            <label>Message Type:</label>
            <select id="message-type">
                <option value="normal">Normal</option>
                <option value="important">Important</option>
                <option value="urgent">Urgent</option>
                <option value="low_priority">Low Priority</option>
            </select>
        </div>
        <div>
            <label>Message:</label>
            <textarea id="message-content" rows="4" placeholder="Enter your message"></textarea>
        </div>
        <button onclick="sendMessage()">Send Message</button>
    </div>
    
    <!-- Messages List -->
    <div class="container">
        <h3>Messages <button onclick="loadMessages()">Refresh</button></h3>
        <div id="messages-list">
            <p>Click "Load Messages" to see your messages</p>
        </div>
    </div>
    
    <!-- Real-time Messages -->
    <div class="container">
        <h3>Real-time Messages</h3>
        <div id="realtime-messages">
            <p>Real-time messages will appear here when WebSocket is connected</p>
        </div>
    </div>

    <script>
        let pusher = null;
        let channel = null;
        let isConnected = false;
        
        // Initialize connection
        function initializeConnection() {
            const apiBaseUrl = document.getElementById('api-base-url').value;
            const authToken = document.getElementById('auth-token').value;
            const userId = document.getElementById('user-id').value;
            
            if (!apiBaseUrl || !authToken || !userId) {
                alert('Please fill in all configuration fields');
                return;
            }
            
            // Store for later use
            window.apiBaseUrl = apiBaseUrl;
            window.authToken = authToken;
            window.userId = userId;
            
            // Initialize Pusher
            try {
                pusher = new Pusher('local', {
                    cluster: 'local',
                    encrypted: false,
                    authEndpoint: apiBaseUrl + '/broadcasting/auth',
                    auth: {
                        headers: {
                            'Authorization': 'Bearer ' + authToken,
                            'X-CSRF-TOKEN': 'test-token'
                        }
                    }
                });
                
                // Subscribe to user channel
                channel = pusher.subscribe('private-user.' + userId);
                
                // Bind to message events
                channel.bind('message.sent', function(data) {
                    console.log('New message received:', data);
                    addRealtimeMessage(data.message);
                });
                
                // Connection events
                pusher.connection.bind('connected', function() {
                    console.log('Connected to messaging service');
                    isConnected = true;
                    updateConnectionStatus('connected', 'ðŸŸ¢ Connected');
                });
                
                pusher.connection.bind('disconnected', function() {
                    console.log('Disconnected from messaging service');
                    isConnected = false;
                    updateConnectionStatus('disconnected', 'ðŸ”´ Disconnected');
                });
                
                pusher.connection.bind('error', function(error) {
                    console.error('Pusher connection error:', error);
                    updateConnectionStatus('error', 'âš ï¸ Connection Error');
                });
                
                console.log('Pusher initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize Pusher:', error);
                updateConnectionStatus('error', 'âš ï¸ Initialization Error');
            }
        }
        
        // Send message
        function sendMessage() {
            const recipientId = document.getElementById('recipient-id').value;
            const subject = document.getElementById('message-subject').value;
            const message = document.getElementById('message-content').value;
            const messageType = document.getElementById('message-type').value;
            
            if (!recipientId || !subject || !message) {
                alert('Please fill in all message fields');
                return;
            }
            
            const data = {
                recipient_id: parseInt(recipientId),
                subject: subject,
                message: message,
                message_type: messageType
            };
            
            fetch(window.apiBaseUrl + '/messages/send', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + window.authToken,
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': 'test-token'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Message sent successfully!');
                    document.getElementById('message-subject').value = '';
                    document.getElementById('message-content').value = '';
                    loadMessages(); // Refresh messages list
                } else {
                    alert('Failed to send message: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
            });
        }
        
        // Load messages
        function loadMessages() {
            fetch(window.apiBaseUrl + '/messages?limit=20', {
                headers: {
                    'Authorization': 'Bearer ' + window.authToken,
                    'X-CSRF-TOKEN': 'test-token'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMessages(data.data.messages);
                } else {
                    document.getElementById('messages-list').innerHTML = '<p>Failed to load messages: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                document.getElementById('messages-list').innerHTML = '<p>Error loading messages: ' + error.message + '</p>';
            });
        }
        
        // Display messages
        function displayMessages(messages) {
            const container = document.getElementById('messages-list');
            
            if (messages.length === 0) {
                container.innerHTML = '<p>No messages found</p>';
                return;
            }
            
            const messagesHtml = messages.map(message => {
                const messageClass = message.message_type === 'urgent' ? 'urgent' : 
                                   message.message_type === 'important' ? 'important' : '';
                
                return `
                    <div class="message ${messageClass}">
                        <strong>${message.sender}</strong> 
                        <span style="float: right; font-size: 12px; color: #666;">${formatTime(message.sent_at)}</span>
                        <div><strong>${message.subject}</strong></div>
                        <div>${message.message}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Type: ${message.message_type} | 
                            ${message.read ? 'Read' : 'Unread'}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = messagesHtml;
        }
        
        // Add real-time message
        function addRealtimeMessage(message) {
            const container = document.getElementById('realtime-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (message.message_type === 'urgent' ? 'urgent' : '');
            messageDiv.innerHTML = `
                <strong>${message.sender}</strong> 
                <span style="float: right; font-size: 12px; color: #666;">${formatTime(message.sent_at)}</span>
                <div><strong>${message.subject}</strong></div>
                <div>${message.message}</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    Type: ${message.message_type} | Real-time delivery
                </div>
            `;
            
            container.insertBefore(messageDiv, container.firstChild);
        }
        
        // Update connection status
        function updateConnectionStatus(status, text) {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.className = 'status ' + status;
            statusDiv.textContent = text;
        }
        
        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        // Auto-initialize if values are provided
        window.addEventListener('load', function() {
            // You can pre-fill these values for testing
            // document.getElementById('api-base-url').value = 'http://localhost/migration_manager_crm/public/api';
            // document.getElementById('auth-token').value = 'your-token-here';
            // document.getElementById('user-id').value = '1';
        });
    </script>
</body>
</html>
