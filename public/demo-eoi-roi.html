<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOI / ROI Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background: #f6f7fb; }
        .page-wrap { padding: 24px; }
        .card { box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        .card-header h4 { margin: 0; font-weight: 600; }
        .split { display: grid; grid-template-columns: 320px 1fr; grid-gap: 16px; }
        .muted { color: #6c757d; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .action-bar { display: flex; align-items: center; justify-content: space-between; }
        .form-grid { display: grid; grid-template-columns: repeat(12, 1fr); grid-gap: 12px; }
        .col-span-6 { grid-column: span 6; }
        .col-span-4 { grid-column: span 4; }
        .col-span-3 { grid-column: span 3; }
        .col-span-12 { grid-column: span 12; }
        .password-wrap { display: flex; align-items: center; }
        .password-wrap .toggle { margin-left: 8px; }
        .table-sm td, .table-sm th { padding: .4rem; }
        .badge-dot { display:inline-flex; align-items:center; }
        .badge-dot::before { content:""; width:8px; height:8px; border-radius:50%; background:#17a2b8; display:inline-block; margin-right:6px; }
        .selector-help { font-size: 12px; }
        .footer-note { font-size: 12px; color: #6c757d; }
    </style>
    <meta name="csrf-token" content="demo">
    <!-- Demo only; no backend calls needed -->
    <script>
        // Minimal helper for ID generation
        function uid() { return Math.random().toString(36).slice(2); }
    </script>
    
</head>
<body>
    <div class="page-wrap">
        <div class="container-fluid">
            <!-- EOI/ROI List Table moved to the top of the page -->
            <div class="card mb-3">
                <div class="card-header action-bar"><h5 class="mb-0">EOI / ROI Entries</h5><button type="button" class="btn btn-primary btn-sm" id="add-eoi-ref"><i class="fas fa-plus mr-1"></i> Add EOI/ROI</button></div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="thead-light">
                                <tr>
                                    <th>EOI Ref</th>
                                    <th>Subclass</th>
                                    <th>Occupation</th>
                                    <th>Points</th>
                                    <th>State(s)</th>
                                    <th>Submission</th>
                                    <th>ROI</th>
                                </tr>
                            </thead>
                            <tbody id="eoiTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header action-bar">
                    <h4><i class="fas fa-star mr-2"></i>EOI / ROI</h4>
                    <div class="d-flex gap-12"></div>
                </div>
                <div class="card-body">
                    <div class="split">
                        <!-- Left: selector -->
                        <div>
                            <div class="form-group">
                                <label class="mb-1">Select EOI/ROI</label>
                                <select id="eoiRefSelector" class="form-control"></select>
                                <small class="muted selector-help d-block mt-2">Maintain multiple EOI/ROI entries for a client. Select to view/edit.
                                </small>
                            </div>
                            <div class="mt-3">
                                <div class="badge badge-light badge-dot">EOI matter context demo</div>
                            </div>
                        </div>

                        <!-- Right: form -->
                        <div>
                            <form id="eoiRefForm" onsubmit="return false;">
                                <input type="hidden" name="id" id="eoi_id" value="">
                                <div class="form-grid">
                                    <div class="form-group col-span-6">
                                        <label>EOI Number</label>
                                        <input type="text" name="EOI_number" class="form-control" placeholder="EOI Number">
                                    </div>
                                    <div class="form-group col-span-6">
                                        <label>Subclass</label>
                                        <input type="text" name="EOI_subclass" class="form-control" placeholder="e.g. 189, 190, 491">
                                    </div>

                                    <div class="form-group col-span-6">
                                        <label>Occupation</label>
                                        <input type="text" name="EOI_occupation" class="form-control" placeholder="ANZSCO occupation">
                                    </div>
                                    <div class="form-group col-span-3">
                                        <label class="d-flex align-items-center">Points <span class="ml-2 badge badge-secondary" id="pointsDeltaBadge" title="Difference from computed total">--</span></label>
                                        <input type="number" name="EOI_point" class="form-control" placeholder="e.g. 85">
                                    </div>
                                    <div class="form-group col-span-3">
                                        <label>State</label>
                                        <input type="text" name="EOI_state" class="form-control" placeholder="VIC, TAS, NSW...">
                                    </div>

                                    <div class="form-group col-span-6">
                                        <label>Submission Date</label>
                                        <input type="text" name="EOI_submission_date" class="form-control" placeholder="dd/mm/yyyy">
                                    </div>
                                    <div class="form-group col-span-3">
                                        <label>ROI</label>
                                        <input type="text" name="EOI_ROI" class="form-control" placeholder="ROI ref">
                                    </div>
                                    <div class="form-group col-span-3">
                                        <label>Password</label>
                                        <div class="password-wrap">
                                            <input type="password" name="EOI_password" class="form-control" placeholder="Password">
                                            <button class="btn btn-outline-secondary btn-sm toggle" id="togglePass" type="button" title="Show/Hide">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="col-span-12 d-flex gap-8">
                                        <button type="button" class="btn btn-success btn-sm" id="saveEoiRef"><i class="fas fa-save mr-1"></i> Save</button>
                                        <button type="button" class="btn btn-danger btn-sm" id="deleteEoiRef"><i class="fas fa-trash mr-1"></i> Delete</button>
                                        <button type="button" class="btn btn-secondary btn-sm" id="resetEoiRef"><i class="fas fa-undo mr-1"></i> Reset</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="footer-note mt-2">This is a static demo. No data is saved to the server.</div>
                </div>
            </div>

            <!-- Points Summary Card (moved below EOI/ROI and above the table) -->
            <div class="card mt-3">
                <div class="card-header action-bar">
                    <h4><i class="fas fa-calculator mr-2"></i>Points Summary</h4>
                    <div class="d-flex align-items-center">
                        <span class="mr-2 muted">Current total:</span>
                        <span class="badge badge-info" id="pointsTotal">--</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Category</th>
                                            <th>Details</th>
                                            <th class="text-right">Points</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pointsBreakdownBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-2"><strong>Upcoming changes</strong></div>
                            <div id="pointsWarnings"></div>
                            <small class="d-block mt-2 footer-note">Demo uses mock client data. In app, these values will be read from the Client Edit sections (age/DOB, English test, assessment, education, work, partner, NAATI, nomination).</small>
                        </div>
                    </div>
                </div>
            </div>

            
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script>
        (function(){
            const select = document.getElementById('eoiRefSelector');
            const tableBody = document.getElementById('eoiTableBody');
            const form = document.getElementById('eoiRefForm');
            const togglePass = document.getElementById('togglePass');
            const pointsTotal = document.getElementById('pointsTotal');
            const pointsBreakdownBody = document.getElementById('pointsBreakdownBody');
            const pointsWarnings = document.getElementById('pointsWarnings');
            const pointsDeltaBadge = document.getElementById('pointsDeltaBadge');

            // Demo dataset (EOIs)
            const eois = [
                { id: uid(), EOI_number: 'E1234567', EOI_subclass: '190', EOI_occupation: '261313 - Software Engineer', EOI_point: 85, EOI_state: 'VIC', EOI_submission_date: '15/07/2025', EOI_ROI: 'VIC-ROI-2025-001', EOI_password: '••••••' },
                { id: uid(), EOI_number: 'E7654321', EOI_subclass: '491', EOI_occupation: '224711 - Management Consultant', EOI_point: 90, EOI_state: 'TAS', EOI_submission_date: '28/06/2025', EOI_ROI: 'TAS-ROI-2025-101', EOI_password: '••••••' },
                { id: uid(), EOI_number: 'E2468101', EOI_subclass: '189', EOI_occupation: '261111 - ICT Business Analyst', EOI_point: 95, EOI_state: 'FED', EOI_submission_date: '02/08/2025', EOI_ROI: '', EOI_password: '••••••' },
            ];

            // Demo client points source (simulating Client Edit data)
            // In the application, these would be computed from DOB, English test date/scores,
            // skills assessment validity, work history, education, partner, NAATI, and nomination.
            const clientPointsSource = {
                age: { label: 'Age', detail: '29 years', points: 30, changesOn: '10/12/2025', nextPoints: 25 },
                english: { label: 'English Test', detail: 'IELTS 8 each (expires 15/01/2027)', points: 20 },
                education: { label: 'Education', detail: 'Australian Master Degree', points: 15 },
                overseasExp: { label: 'Overseas Work', detail: '3 years (IT)', points: 5, changesOn: '01/11/2026', nextPoints: 10 },
                ausExp: { label: 'Australian Work', detail: '1 year (IT)', points: 5 },
                partner: { label: 'Partner Skills', detail: 'Competent English only', points: 5, changesOn: null },
                naati: { label: 'NAATI/CCL', detail: 'Not claimed', points: 0 },
                nomination: { label: 'State Nomination (190)', detail: 'If nominated', points: 5 },
            };

            function renderSelect(){
                select.innerHTML = '';
                eois.forEach(ref => {
                    const o = document.createElement('option');
                    o.value = ref.id;
                    const statesTxt = Array.isArray(ref.EOI_states) && ref.EOI_states.length ? ref.EOI_states.join(', ') : (ref.EOI_state || 'N/A');
                    const subclassTxt = Array.isArray(ref.EOI_subclasses) && ref.EOI_subclasses.length ? ref.EOI_subclasses.join(', ') : (ref.EOI_subclass || 'Subclass');
                    o.textContent = `${statesTxt} • ${subclassTxt} • ${ref.EOI_point || 0} pts`;
                    select.appendChild(o);
                });
            }

            function renderTable(){
                tableBody.innerHTML = '';
                eois.forEach(ref => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-id', ref.id);
                    const subclassOptions = ['189','190','491'];
                    const stateOptions = ['ACT','NSW','NT','QLD','SA','TAS','VIC','WA','FED'];

                    if(!Array.isArray(ref.EOI_subclasses)){
                        ref.EOI_subclasses = ref.EOI_subclass ? [String(ref.EOI_subclass)] : [];
                    }
                    if(!Array.isArray(ref.EOI_states)){
                        ref.EOI_states = ref.EOI_state ? [String(ref.EOI_state)] : [];
                    }

                    tr.innerHTML = `
                        <td>${ref.EOI_number || 'N/A'}</td>
                        <td>${(ref.EOI_subclasses && ref.EOI_subclasses.length ? ref.EOI_subclasses.join(', ') : (ref.EOI_subclass || 'N/A'))}</td>
                        <td>${ref.EOI_occupation || 'N/A'}</td>
                        <td>${ref.EOI_point || 'N/A'}</td>
                        <td>${(ref.EOI_states && ref.EOI_states.length ? ref.EOI_states.join(', ') : (ref.EOI_state || 'N/A'))}</td>
                        <td>${ref.EOI_submission_date || 'N/A'}</td>
                        <td>${ref.EOI_ROI || 'N/A'}</td>
                    `;
                    tr.addEventListener('click', (e) => {
                        select.value = ref.id;
                        fillForm(ref);
                    });
                    tableBody.appendChild(tr);
                });
            }

            function clearForm(){
                form.reset();
                document.getElementById('eoi_id').value = '';
            }

            function fillForm(item){
                if(!item){ clearForm(); return; }
                document.getElementById('eoi_id').value = item.id || '';
                form.EOI_number.value = item.EOI_number || '';
                form.EOI_subclass.value = (Array.isArray(item.EOI_subclasses) && item.EOI_subclasses.length) ? item.EOI_subclasses[0] : (item.EOI_subclass || '');
                form.EOI_occupation.value = item.EOI_occupation || '';
                form.EOI_point.value = item.EOI_point || '';
                form.EOI_state.value = (Array.isArray(item.EOI_states) && item.EOI_states.length) ? item.EOI_states[0] : (item.EOI_state || '');
                form.EOI_submission_date.value = item.EOI_submission_date || '';
                form.EOI_ROI.value = item.EOI_ROI || '';
                form.EOI_password.value = (item.EOI_password && item.EOI_password !== '••••••') ? item.EOI_password : '';
            }

            function collectForm(){
                return {
                    id: document.getElementById('eoi_id').value || uid(),
                    EOI_number: form.EOI_number.value || '',
                    EOI_subclass: form.EOI_subclass.value || '',
                    EOI_occupation: form.EOI_occupation.value || '',
                    EOI_point: form.EOI_point.value || '',
                    EOI_state: form.EOI_state.value || '',
                    EOI_submission_date: form.EOI_submission_date.value || '',
                    EOI_ROI: form.EOI_ROI.value || '',
                    EOI_password: form.EOI_password.value || '••••••'
                };
            }

            function computePointsTotal(){
                // Sum of current claimed points (excluding conditional nomination bonus unless selected EOI is 190)
                const base = Object.values(clientPointsSource).reduce((sum, it) => sum + (Number(it.points) || 0), 0);
                const selected = eois.find(x => String(x.id) === String(select.value));
                // If selected subclass is 491, nomination points are 15; if 190, 5; otherwise 0
                let nominationPoints = 0;
                if(selected){
                    if(String(selected.EOI_subclass).trim() === '491'){ nominationPoints = 15; }
                    else if(String(selected.EOI_subclass).trim() === '190'){ nominationPoints = 5; }
                }
                const total = base - (clientPointsSource.nomination.points || 0) + nominationPoints;
                return { total, nominationPoints };
            }

            function renderPointsBreakdown(){
                pointsBreakdownBody.innerHTML = '';
                Object.values(clientPointsSource).forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.label}</td>
                        <td>${item.detail || ''}</td>
                        <td class="text-right">${item.points || 0}</td>
                    `;
                    pointsBreakdownBody.appendChild(tr);
                });

                const { total } = computePointsTotal();
                pointsTotal.textContent = total;
            }

            function withinMonths(dateStr, months){
                if(!dateStr) return false;
                const [d,m,y] = dateStr.split('/').map(x => parseInt(x, 10));
                if(!d || !m || !y) return false;
                const now = new Date();
                const future = new Date(y, m-1, d);
                const threshold = new Date();
                threshold.setMonth(threshold.getMonth() + months);
                return future <= threshold && future >= now;
            }

            function renderWarnings(){
                const warnings = [];
                Object.values(clientPointsSource).forEach(it => {
                    if(it.changesOn && withinMonths(it.changesOn, 6)){
                        const next = (it.nextPoints !== undefined) ? ` → ${it.nextPoints} pts` : '';
                        warnings.push(`<div class="alert alert-warning py-2 px-3 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i><strong>${it.label}</strong> likely changes around <strong>${it.changesOn}</strong> (now ${it.points} pts${next}).</div>`);
                    }
                });
                pointsWarnings.innerHTML = warnings.length ? warnings.join('') : '<div class="text-muted">No expected changes in the next 6 months.</div>';
            }

            function updatePointsDeltaBadge(){
                const { total } = computePointsTotal();
                const entered = Number(form.EOI_point.value || 0);
                const delta = entered - total;
                if(Number.isNaN(delta)){ pointsDeltaBadge.textContent = '--'; return; }
                pointsDeltaBadge.textContent = (delta === 0 ? 'match' : (delta > 0 ? `+${delta}` : `${delta}`));
                pointsDeltaBadge.className = 'ml-2 badge ' + (delta === 0 ? 'badge-success' : (delta > 0 ? 'badge-primary' : 'badge-warning'));
            }

            // Events
            document.getElementById('add-eoi-ref').addEventListener('click', function(){
                select.value = '';
                clearForm();
                form.EOI_state.focus();
            });

            document.getElementById('saveEoiRef').addEventListener('click', function(){
                const payload = collectForm();
                const idx = eois.findIndex(x => String(x.id) === String(payload.id));
                if(idx >= 0){
                    eois[idx] = payload;
                } else {
                    eois.unshift(payload);
                }
                renderSelect();
                renderTable();
                select.value = payload.id;
                fillForm(payload);
                renderPointsBreakdown();
                renderWarnings();
                updatePointsDeltaBadge();
            });

            document.getElementById('deleteEoiRef').addEventListener('click', function(){
                const id = document.getElementById('eoi_id').value;
                if(!id) return;
                if(!confirm('Delete this EOI/ROI entry?')) return;
                const idx = eois.findIndex(x => String(x.id) === String(id));
                if(idx >= 0){ eois.splice(idx, 1); }
                renderSelect();
                renderTable();
                clearForm();
                if(select.options.length){
                    select.selectedIndex = 0;
                    const item = eois[0];
                    fillForm(item);
                }
                renderPointsBreakdown();
                renderWarnings();
                updatePointsDeltaBadge();
            });

            document.getElementById('resetEoiRef').addEventListener('click', function(){
                if(select.value){
                    const item = eois.find(x => String(x.id) === String(select.value));
                    fillForm(item);
                } else {
                    clearForm();
                }
            });

            select.addEventListener('change', function(){
                const item = eois.find(x => String(x.id) === String(this.value));
                fillForm(item);
                renderPointsBreakdown();
                renderWarnings();
                updatePointsDeltaBadge();
            });

            togglePass.addEventListener('click', function(){
                const input = form.EOI_password;
                if(input.type === 'password'){
                    input.type = 'text';
                    this.firstElementChild.classList.remove('fa-eye');
                    this.firstElementChild.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    this.firstElementChild.classList.remove('fa-eye-slash');
                    this.firstElementChild.classList.add('fa-eye');
                }
            });

            // Initial render
            renderSelect();
            renderTable();
            if(select.options.length){
                const first = eois.find(x => String(x.id) === String(select.value));
                fillForm(first);
            }
            renderPointsBreakdown();
            renderWarnings();
            updatePointsDeltaBadge();

            // Live delta update when user changes entered EOI points
            form.EOI_point.addEventListener('input', updatePointsDeltaBadge);
        })();
    </script>
</body>
</html>


